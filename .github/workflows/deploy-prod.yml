name: Deploy & Run Unified Orders DLT (prod)
on:
  workflow_dispatch:   # allows manual trigger
jobs:
  deploy-run-prod:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout your repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      # 2. Install Databricks CLI (official action)
      - name: Set up Databricks CLI
        uses: databricks/setup-cli@main
      # 3. Validate and deploy bundle
      - name: Validate & Deploy Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Validating DAB bundle..."
          databricks bundle validate --target prod
          echo "Deploying DAB bundle..."
          databricks bundle deploy --target prod
      # 4. Run the DLT pipeline once right after deployment
      - name: Run the DLT pipeline once
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Running unified_orders_dlt pipeline..."
          databricks bundle run unified_orders_dlt --target prod --refresh all
